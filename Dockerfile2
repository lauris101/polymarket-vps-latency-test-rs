# STAGE 1: Builder
FROM rust:latest as builder

# --- NEW BLOCK START ---
# We switch to the parent directory inside the container
WORKDIR /usr/src

# Copy the library folder from your host into the container
# Note: We rely on the build context being the parent folder (see Step 2)
COPY ./rs-clob-client ./rs-clob-client
# --- NEW BLOCK END ---

# Now go back to your bot's directory
WORKDIR /usr/src/bot
USER root

# 1. OPTIMIZATION MAGIC HAPPENS HERE
ENV RUSTFLAGS="-C target-cpu=native"

# Copy your manifests
COPY ./polymarket-vps-latency-test-rs/Cargo.lock ./Cargo.lock
COPY ./polymarket-vps-latency-test-rs/Cargo.toml ./Cargo.toml

# Create dummy main.rs to cache dependencies
RUN mkdir src && \
    echo "fn main() {println!(\"if you see this, the build failed\")}" > src/main.rs
RUN cargo build --release

# Copy the source code
COPY ./polymarket-vps-latency-test-rs/src ./src

# Force rebuild
RUN touch src/main.rs
RUN cargo build --release

# STAGE 2: Runtime
FROM debian:trixie-slim

RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /usr/src/bot/target/release/poly-official-tester /usr/local/bin/bot

ENTRYPOINT ["bot"]
